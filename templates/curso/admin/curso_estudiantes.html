{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Estudiantes - {{ curso.nombre }}{% endblock %}

{% block content %}
<div class="w-full">

    <!-- Alertas ERP -->
    {% if not curso.plantilla_certificado or not curso.configuracion_certificado %}
    <div class="mb-4 bg-amber-50 border-l-4 border-amber-400 p-4 rounded-sm shadow-sm">
        <div class="flex">
            <div class="flex-shrink-0"><i class="fas fa-triangle-exclamation text-amber-500"></i></div>
            <div class="ml-3">
                <p class="text-xs text-amber-700 font-bold uppercase tracking-wider mb-1">Configuración requerida</p>
                <p class="text-xs text-amber-700">El certificado no ha sido diseñado aún. <a
                        href="{% url 'curso:config' curso.pk %}"
                        class="underline font-bold hover:text-amber-900">Diseñar ahora</a></p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Header Estilo User List -->
    <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 bg-white p-3 border border-gray-200 rounded-sm shadow-sm">
        <div>
            <h1 class="text-lg font-bold text-gray-800 uppercase tracking-tight">Estudiantes Inscritos</h1>
        </div>

        <div class="mt-3 sm:mt-0 flex flex-wrap gap-2">
            <a href="{% url 'curso:estudiante_add' curso.pk %}"
                class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-sm shadow-sm text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors uppercase">
                <i class="fas fa-user-plus mr-1 text-gray-400"></i> Añadir
            </a>
            <form method="post" action="{% url 'curso:generar_todos' curso.pk %}" data-requires-config="true">
                {% csrf_token %}
                <button type="submit"
                    class="inline-flex items-center px-3 py-1.5 border border-transparent rounded-sm shadow-sm text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors uppercase"
                    data-has-config="{% if curso.plantilla_certificado and curso.configuracion_certificado %}true{% else %}false{% endif %}">
                    <i class="fas fa-bolt-lightning mr-1"></i> Generar
                </button>
            </form>
            <a href="{% url 'curso:descargar_zip' curso.pk %}"
                class="inline-flex items-center px-3 py-1.5 border border-transparent rounded-sm shadow-sm text-xs font-medium text-white bg-green-600 hover:bg-green-700 transition-colors uppercase {% if not estudiantes_con_cert %}opacity-50 cursor-not-allowed pointer-events-none{% endif %}"
                {% if not estudiantes_con_cert %}disabled{% endif %}>
                <i class="fas fa-file-zipper mr-1"></i> ZIP
            </a>
        </div>
    </div>

    <!-- DataGrid -->
    {% if estudiantes %}
    <div class="bg-white border border-gray-300 rounded-sm shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th
                            class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                            Datos del Estudiante</th>
                        <th
                            class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                            Identificación</th>
                        <th
                            class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                            Estado PDF</th>
                        <th
                            class="px-4 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                            Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                    {% for est in estudiantes %}
                    {% with cert=est.certificados.first %}
                    <tr class="hover:bg-blue-50 transition-colors">
                        <td class="px-4 py-2">
                            <div class="flex flex-col">
                                <span class="text-xs font-bold text-gray-900">{{ est.nombre_completo }}</span>
                                <span class="text-[10px] text-gray-500">{{ est.correo|default:"Sin correo" }}</span>
                            </div>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            <span
                                class="px-1.5 py-0.5 bg-gray-100 border border-gray-200 rounded-sm text-[10px] font-mono text-gray-600">{{ est.cedula }}</span>
                        </td>
                        <td class="px-4 py-2 text-center">
                            {% if cert and cert.archivo_generado %}
                            <span
                                class="inline-flex items-center px-1.5 py-0.5 rounded-sm bg-green-100 text-green-800 text-[10px] font-bold border border-green-200 uppercase">
                                Generado
                            </span>
                            {% else %}
                            <span
                                class="inline-flex items-center px-1.5 py-0.5 rounded-sm bg-amber-100 text-amber-800 text-[10px] font-bold border border-amber-200 uppercase">
                                Pendiente
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-2 text-right whitespace-nowrap text-xs font-medium space-x-1">
                            <form method="post" action="{% url 'curso:generar_individual' est.pk %}" class="inline"
                                data-requires-config="true">
                                {% csrf_token %}
                                <button type="submit"
                                    class="text-indigo-600 hover:text-indigo-900 bg-white border border-gray-300 px-2 py-1 rounded-sm shadow-sm hover:bg-gray-50 inline-block mb-0.5"
                                    title="Generar PDF"
                                    data-has-config="{% if curso.plantilla_certificado and curso.configuracion_certificado %}true{% else %}false{% endif %}">
                                    <i class="fas fa-arrows-rotate"></i>
                                </button>
                            </form>

                            {% if cert and cert.archivo_generado %}
                            {% with status=cert.status_archivo %}
                            {% if status.exists %}
                            <a href="{% url 'curso:certificate_download' cert.pk %}" target="_blank"
                                class="text-blue-600 hover:text-blue-900 bg-white border border-gray-300 px-2 py-1 rounded-sm shadow-sm hover:bg-gray-50 inline-block mb-0.5"
                                title="Ver / Descargar">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% else %}
                            <span
                                class="text-red-500 bg-red-50 border border-red-200 px-2 py-1 rounded-sm inline-block mb-0.5 cursor-help"
                                title="Error: El archivo no existe en el NAS">
                                <i class="fas fa-file-circle-exclamation"></i>
                            </span>
                            {% endif %}
                            {% endwith %}
                            {% else %}
                            <span
                                class="text-gray-300 bg-gray-50 border border-gray-200 px-2 py-1 rounded-sm inline-block mb-0.5 cursor-not-allowed"><i
                                    class="fas fa-eye"></i></span>
                            {% endif %}

                            <a href="{% url 'curso:estudiante_edit' est.pk %}"
                                class="text-gray-600 hover:text-gray-900 bg-white border border-gray-300 px-2 py-1 rounded-sm shadow-sm hover:bg-gray-50 inline-block mb-0.5"
                                title="Editar">
                                <i class="fas fa-pen"></i>
                            </a>
                            <a href="{% url 'curso:estudiante_delete' est.pk %}"
                                class="text-red-600 hover:text-red-900 bg-white border border-gray-300 px-2 py-1 rounded-sm shadow-sm hover:bg-gray-50 inline-block mb-0.5"
                                title="Eliminar">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="bg-white border border-gray-300 rounded-sm shadow-sm p-10 text-center">
        <i class="fas fa-users-slash text-4xl text-gray-200 mb-3"></i>
        <h3 class="text-sm font-bold text-gray-900 uppercase">Sin estudiantes</h3>
        <p class="text-xs text-gray-500 mt-1 max-w-xs mx-auto mb-6">Cargue la nómina desde los ajustes del curso o
            registre manualmente.</p>
        <a href="{% url 'curso:edit' curso.pk %}"
            class="inline-flex items-center px-3 py-1.5 border border-transparent rounded-sm shadow-sm text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors uppercase">
            <i class="fas fa-upload mr-1"></i> Importar Excel
        </a>
    </div>
    {% endif %}

</div>
<!-- LOADING OVERLAY -->
<div id="full-screen-loader" class="fixed inset-0 z-[9999] hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity"></div>

    <!-- Content -->
    <div class="relative flex min-h-screen items-center justify-center p-4">
        <div
            class="w-full max-w-md transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all">
            <div class="flex flex-col items-center justify-center text-center">
                <!-- Icono de Estado -->
                <div class="mb-4 relative">
                    <div id="loader-spinner" class="w-16 h-16 border-4 border-indigo-100 rounded-full animate-spin"></div>
                    <div id="loader-spinner-top" class="w-16 h-16 border-4 border-t-indigo-600 rounded-full animate-spin absolute top-0 left-0"></div>
                    <i id="loader-icon" class="fas fa-bolt absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-indigo-600 text-xl"></i>
                </div>

                <h3 id="loader-title" class="text-lg font-black text-gray-900 leading-6 mb-1">Procesando...</h3>
                <p id="loader-desc" class="text-sm text-gray-600 mb-4">Por favor esperar, no cierres la ventana.</p>

                <!-- Barra de Progreso -->
                <div id="progress-container" class="w-full bg-gray-200 rounded-full h-4 mb-2 hidden">
                    <div id="progress-bar" class="bg-indigo-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="progress-stats" class="flex justify-between w-full text-xs text-gray-500 font-mono hidden">
                    <span id="progress-percent">0%</span>
                    <span id="progress-text">Iniciando...</span>
                </div>

                <!-- Mensaje final / Error -->
                <div id="result-message" class="mt-4 hidden p-3 rounded-md text-sm w-full text-left"></div>

                <div class="mt-4 flex justify-center hidden" id="action-buttons">
                    <button type="button" onclick="window.location.reload()" class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700">
                        Aceptar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Elements
        const loader = document.getElementById('full-screen-loader');
        const loaderTitle = document.getElementById('loader-title');
        const loaderDesc = document.getElementById('loader-desc');
        const loaderIcon = document.getElementById('loader-icon');
        
        // Progress Elements
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressStats = document.getElementById('progress-stats');
        const progressPercent = document.getElementById('progress-percent');
        const progressText = document.getElementById('progress-text');
        
        // Result Elements
        const resultMessage = document.getElementById('result-message');
        const actionButtons = document.getElementById('action-buttons');
        const loaderSpinner = document.getElementById('loader-spinner');
        const loaderSpinnerTop = document.getElementById('loader-spinner-top');

        // Helper: Reset Loader State
        function resetLoader() {
            loader.classList.add('hidden');
            progressContainer.classList.add('hidden');
            progressStats.classList.add('hidden');
            resultMessage.classList.add('hidden');
            actionButtons.classList.add('hidden');
            
            // Show Spinner
            loaderSpinner.classList.remove('hidden');
            loaderSpinnerTop.classList.remove('hidden');
            
            // Reset Text
            loaderTitle.textContent = 'Procesando...';
            loaderDesc.textContent = 'Por favor esperar, no cierres la ventana.';
            progressBar.style.width = '0%';
        }

        /**
         * Helper to show simple loader (no progress bar)
         */
        function showLoader(title, desc, iconClass = 'fa-bolt') {
            resetLoader();
            loaderTitle.textContent = title;
            loaderDesc.innerHTML = desc;
            
            loaderIcon.className = `fas ${iconClass} absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-indigo-600 text-xl`;
            loader.classList.remove('hidden');
        }

        // ============================================================
        // 1. GENERAR TODOS (MASIVO - AHORA ASÍNCRONO)
        // ============================================================
        const generateAllForm = document.querySelector('form[action*="generar-todos"]');
        const courseId = "{{ curso.pk }}"; // Context variable

        if (generateAllForm) {
            generateAllForm.addEventListener('submit', function (e) {
                e.preventDefault();
                
                // 1. Check Config
                const btn = this.querySelector('button[type="submit"]');
                const hasConfig = btn.dataset.hasConfig === 'true';
                if (!hasConfig) {
                    alert('⚠️ Configuración requerida\n\nEl certificado no ha sido diseñado aún.');
                    return;
                }

                // 2. Start UI
                resetLoader();
                loaderTitle.textContent = 'Generando Certificados';
                loaderDesc.textContent = 'Iniciando proceso en segundo plano...';
                loaderIcon.className = 'fas fa-cogs absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-indigo-600 text-xl';
                
                loader.classList.remove('hidden');
                progressContainer.classList.remove('hidden');
                progressStats.classList.remove('hidden');

                // 3. AJAX Request to Start Task
                const formData = new FormData(this);
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Start Polling
                        startPolling(courseId);
                    } else {
                        showError(data.error || 'Error al iniciar el proceso.');
                    }
                })
                .catch(err => {
                    showError('Error de conexión al servidor.');
                    console.error(err);
                });
            });
        }

        // Polling Function
        let pollInterval;
        function startPolling(pk) {
            pollInterval = setInterval(() => {
                fetch(`{% url 'curso:generar_progreso' 0 %}`.replace('0', pk))
                .then(res => res.json())
                .then(data => {
                    // Update UI
                    const p = data.progress || 0;
                    progressBar.style.width = `${p}%`;
                    progressPercent.textContent = `${p}%`;
                    progressText.textContent = getStatusText(data.status);

                    if (data.is_complete) {
                        clearInterval(pollInterval);
                        setTimeout(() => showSuccess(), 500);
                    }
                })
                .catch(err => console.error("Polling error:", err));
            }, 1000);
        }

        function getStatusText(status) {
            if (status === 'processing') return 'Procesando...';
            if (status === 'completed') return 'Finalizando...';
            if (status === 'idle') return 'En espera...';
            return 'Estado desconocido';
        }

        function showSuccess() {
            loaderSpinner.classList.add('hidden');
            loaderSpinnerTop.classList.add('hidden');
            loaderIcon.className = 'fas fa-check-circle text-green-500 text-5xl static transform-none';
            
            loaderTitle.textContent = '¡Proceso Completado!';
            loaderDesc.textContent = 'Todos los certificados han sido generados exitosamente.';
            
            // Hide progress
            progressContainer.classList.add('hidden');
            progressStats.classList.add('hidden');
            
            actionButtons.classList.remove('hidden');
        }

        function showError(msg) {
            clearInterval(pollInterval);
            loaderSpinner.classList.add('hidden');
            loaderSpinnerTop.classList.add('hidden');
            loaderIcon.className = 'fas fa-times-circle text-red-500 text-5xl static transform-none';
            
            loaderTitle.textContent = 'Error';
            loaderDesc.textContent = 'Hubo un problema durante el proceso.';
            
            resultMessage.textContent = msg;
            resultMessage.className = 'mt-4 p-3 rounded-md text-sm w-full text-left bg-red-50 text-red-700 border border-red-200';
            resultMessage.classList.remove('hidden');
            
            actionButtons.classList.remove('hidden');
        }

        // ============================================================
        // 2. OTHER HANDLERS (Same as before but simplified helper)
        // ============================================================
        const individualForms = document.querySelectorAll('form[action*="generar-certificado"]');
        individualForms.forEach(form => {
            form.addEventListener('submit', function (e) {
                // Check config local
               const btn = this.querySelector('button');
               if(btn && btn.dataset.hasConfig === 'false') {
                   e.preventDefault();
                   alert('⚠️ Configuración requerida');
                   return;
               }
               showLoader('Generando PDF', 'Por favor espera...', 'fa-file-pdf');
            });
        });

        const zipLink = document.querySelector('a[href*="descargar_zip"]');
        if (zipLink) {
            zipLink.addEventListener('click', function (e) {
                if (this.classList.contains('pointer-events-none')) return;
                e.preventDefault();
                showLoader('Preparando ZIP', 'Comprimiendo archivos...', 'fa-file-zipper');
                setTimeout(() => {
                    window.location.href = this.href;
                    setTimeout(() => loader.classList.add('hidden'), 5000);
                }, 500);
            });
        }
    });
</script>
{% endblock %}